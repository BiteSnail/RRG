using System.Collections;
using System.Collections.Generic;
using TMPro;
using Unity.VisualScripting;
using UnityEngine;
using UnityEngine.SceneManagement;

public class Stage1 : StageBase
{
    public GameObject itemPos_L;
    public GameObject itemPos_R;
    public TextMeshProUGUI respondText;
    Vector3 targetPos;

    bool pressed = true;


    public override void Start()
    {
        base.Start();
        Managers.Sound.Play("School_cut", SoundManager.Sound.Bgm);

        StartCoroutine(EndStage());
    }
    private void Update()
    {
    
        currentTime += Time.deltaTime;

        if (item == null)
            targetPos = itemSpawnPos.transform.position;

        if (Input.GetKeyDown(KeyCode.Space)&& gameStarted && !pressed) //특수키
        {
            if(IsCorrectHit())
            {
                if (item.type == ItemType.General)
                {
                    //맞음 
                    targetPos = generalPos.transform.position;
                    Managers.Sound.Play("General");
                    SetCorrectText();
                }
                else //박자는 맞았는데 분류가 틀림
                {
                    Managers.Sound.Play("Fail");
                    SetWrongtText();
                }   
            }
            else //쓰레기를 놓침
            {
                SetMissText();
            }

        }
        else if (Input.GetKeyDown(KeyCode.Q) && gameStarted && !pressed) //플라스틱
        {
            if (IsCorrectHit())            
            {
                if(item.type == ItemType.Plastic)
                {   
                    //맞음 
                    targetPos = plasticPos.transform.position;
                    Managers.Sound.Play("Plastic");
                    SetCorrectText();
                }
                else
                {
                    //틀림
                    Managers.Sound.Play("Fail");
                    SetWrongtText();
                }
            }
            else
            {
                SetMissText();
            }
            pressed = true;
        }
        else if (Input.GetKeyDown(KeyCode.W) && gameStarted && !pressed) //캔
        {
            if(IsCorrectHit())
            {
                if (item.type == ItemType.Can)
                {
                    //맞음 
                    targetPos = canPos.transform.position;
                    Managers.Sound.Play("Can");
                    SetCorrectText();
                }
                else
                {
                    //틀림
                    Managers.Sound.Play("Fail");
                    SetWrongtText();
                }
            }
            else
            {
                SetMissText();
            }
            
            pressed = true;
        }

        else if (Input.GetKeyDown(KeyCode.E) && gameStarted && !pressed) //유리
        {
            if(IsCorrectHit())
            {
                if (item.type == ItemType.Glass)
                {
                    //맞음 
                    targetPos = glassPos.transform.position;
                    Managers.Sound.Play("Glass");
                    SetCorrectText();
                }
                else
                {
                    //틀림
                    Managers.Sound.Play("Fail");
                    SetWrongtText();
                }
            }
            else
            {
                SetMissText();
            }
            
            pressed = true;
        }
        else if (Input.GetKeyDown(KeyCode.R) && gameStarted && !pressed) //종이
        {
            if(IsCorrectHit())
            {
                if (item.type == ItemType.Paper)
                {
                    //맞음 
                    targetPos = paperPos.transform.position;
                    Managers.Sound.Play("Paper");
                    SetCorrectText();
                }
                else
                {
                    //틀림
                    Managers.Sound.Play("Fail");
                    SetWrongtText();
                }
            }
            else
            {
                SetMissText();
            }
            pressed = true;
        }

        if (item)
        {
            float distance = Vector2.Distance(item.transform.position, targetPos);
            if (distance > 0.1f)
            {
                Vector2 direction = (targetPos - item.transform.position).normalized;
                item.transform.Translate(direction * itemMoveSpeed * Time.deltaTime);

                if (targetPos != itemPos_L.transform.position && targetPos != itemPos_R.transform.position)
                    item.transform.localScale = Vector2.Lerp(item.transform.localScale, Vector2.zero, Time.deltaTime);
            }
            else if (targetPos != hitBox.transform.position)
            {
                DestroyItem();
            }
                
        }

        if (currentTime >= 60d / bpm) //매 박자마다
        {
            nowBeatIndex++;
            currentTime -= 60d / bpm;
            //Managers.Sound.Play("Beat");
            if (isHitBeat[nowBeatIndex] == true)
            {
                Item randomItem = Managers.Resource.GetRandomItem();
                item = GameObject.Instantiate(randomItem);
                randomItem.isEncounter = true;

                //아이템 스폰 위치 (좌 / 우) 
                int rand = Random.Range(0, 2);
                if (rand == 0)
                {
                    item.transform.parent = itemPos_L.transform;
                    targetPos =itemPos_R.transform.position;
                }
                else
                {
                    item.transform.parent = itemPos_R.transform;
                    targetPos = itemPos_L.transform.position;
                }

                pressed = false;
                item.transform.localPosition = new Vector2(0, 0);
                Managers.Sound.Play("ItemSpawn");
            }
        }

    }

    IEnumerator EndStage()
    {
        yield return new WaitForSeconds(Managers.Resource.GetAudio("School_cut").length);
        SceneManager.LoadScene("Main");
    }

    void SetCorrectText()
    {
        respondText.SetText("좋아!");
    }
    void SetWrongtText()
    {
        respondText.SetText("틀렸어");
    }
    void SetMissText()
    {
        respondText.SetText("놓쳤어");
    }
}
